# Crypto Exchange Tutorials

## 背景知识
### 杠杆（Leverage）
* 杠杆允许用户以较小的资金（保证金）控制更大的仓位。例如，10 倍杠杆下，1000 美元的保证金可以开 10000 美元的仓位。
* `仓位价值 = 保证金 × 杠杆`。

### 保证金（Margin）
* 保证金是用户为开仓提供的资金，通常是仓位价值的一部分。
* `初始保证金 = 仓位价值 / 杠杆`。

### 清算
* 当市场价格波动导致账户的未实现亏损接近或超过保证金时，交易所会触发清算，以避免账户余额变为负数。
* 清算价格是账户权益（Equity）变为0的临界价格。

### 持仓量（Quantity）
* 表示用户持有的合约数量（单位可以是张数或币数）。
* `仓位价值 = 持仓量 × 开仓价格`。

### 保证金率（Margin Rate）
保证金率通常分为两种：
* 初始保证金率（Initial Margin Rate）
  * 用户开仓时需要提供的保证金占仓位价值的百分比。
  * 公式：`初始保证金 = 仓位价值 × 初始保证金率`。
  * 与杠杆直接相关：`初始保证金率 = 1 / 杠杆`。
* 维持保证金率（Maintenance Margin Rate）
  * 用户持仓时，账户权益（Equity）必须维持的最低保证金占仓位价值的百分比。
  * 如果账户权益低于维持保证金要求，交易所会触发清算。
  * 通常`维持保证金率 < 初始保证金率`。

#### 示例
* 假设杠杆为10x
  * 初始保证金率 = 1 / 10 = 10%。
  * 仓位价值 10000，保证金 = 10000 × 10% = 1000。
* 维持保证金率可能为5%
  * 维持保证金 = 10000 × 5% = 500。
  * 如果账户权益跌至 500 以下，清算触发。

## 清算
### 亏损计算
* 多
  * `未实现盈亏（PnL）= 持仓量 × (当前价格 - 开仓价格)`。
  * 对于多头，当价格下跌时，`PnL`为负。
* 空
  * `未实现盈亏（PnL）= 持仓量 × (开仓价格 - 当前价格)`。
  * 对于空头，当价格上升时，`PnL`为负。

### 清算条件
* 清算发生在账户权益 = 0 时。
* 账户权益 = 初始保证金 + 未实现盈亏。
* 清算时，初始保证金 + `PnL` = 0

### 清算价格
* 无保证金率
  * `多头清算价格 = 开仓价格 - (保证金 / 持仓量)`
  * `空头清算价格 = 开仓价格 + (保证金 / 持仓量)`
* 有保证金率
  * `多头清算价格 = 开仓价格 × (1 - 1/杠杆) / (1 - 维持保证金率)`
  * `空头清算价格 = 开仓价格 × (1 + 1/杠杆) / (1 + 维持保证金率)`
### 推导
#### 多头无保证金率清算
```
清算条件：初始保证金 + 持仓量 × (清算价格 - 开仓价格) = 0

1. 初始保证金 = 仓位价值 / 杠杆 = (持仓量 × 开仓价格) / 杠杆
2. 代入清算条件
   (持仓量 × 开仓价格) / 杠杆 + 持仓量 × (清算价格 - 开仓价格) = 0
3. 提取公因式 持仓量
   持仓量 × [(开仓价格 / 杠杆) + (清算价格 - 开仓价格)] = 0
4. 由于持仓量 ≠ 0，括号内部分 = 0
   开仓价格 / 杠杆 + 清算价格 - 开仓价格 = 0
5. 整理
   清算价格 = 开仓价格 - (开仓价格 / 杠杆) 
6. 因为：保证金 = 持仓量 × 开仓价格 / 杠杆
   开仓价格 / 杠杆 = 保证金 / 持仓量
7. 最终
   清算价格 = 开仓价格 - (保证金 / 持仓量)
```
##### 空头无保证金率清算
```
清算条件：初始保证金 + 持仓量 × (开仓价格 - 清算价格) = 0

1. 初始保证金 = 仓位价值 / 杠杆 = (持仓量 × 开仓价格) / 杠杆
2. 代入清算条件
   (持仓量 × 开仓价格) / 杠杆 + 持仓量 × (开仓价格 - 清算价格) = 0
3. 提取公因式 持仓量
   持仓量 × [(开仓价格 / 杠杆) + (开仓价格 - 清算价格)] = 0
4. 由于持仓量 ≠ 0，括号内部分 = 0
   开仓价格 / 杠杆 + 开仓价格 - 清算价格 = 0
5. 整理
   清算价格 = 开仓价格 + (开仓价格 / 杠杆) 
6. 因为：保证金 = 持仓量 × 开仓价格 / 杠杆
   开仓价格 / 杠杆 = 保证金 / 持仓量 
7. 最终
   清算价格 = 开仓价格 + (保证金 / 持仓量)
```
#### 直观理解
* `(保证金 / 持仓量)` 表示每单位持仓的保证金。
* 多头清算价格是开仓价格减去每单位持仓的保证金，因为价格下跌到这个点时，亏损刚好耗尽保证金。
* 空头清算价格是开仓价格加上每单位持仓的保证金，因为价格上涨到这个点时，亏损刚好耗尽保证金。

#### 为什么会有这样的差异？
* 多头：
  * 价格下跌导致亏损，清算价格低于开仓价格。
  * 亏损幅度取决于保证金能承受的下跌空间。
* 空头：
  * 价格上涨导致亏损，清算价格高于开仓价格。
  * 亏损幅度取决于保证金能承受的上涨空间。

#### 多头有保证金率清算
```
清算条件：初始保证金 + 持仓量 × (清算价格 - 开仓价格) = 持仓量 × 清算价格 × 维持保证金率

1. 初始保证金 = 持仓量 × 清算价格 × 维持保证金率 - 持仓量 × (清算价格 - 开仓价格)
2. 提取公因子 持仓量
   初始保证金 = 持仓量 × [清算价格 × 维持保证金率 - 清算价格 + 开仓价格]
3. 求解
   清算价格 × (维持保证金率 - 1) + 开仓价格 = 初始保证金 / 持仓量
   清算价格 = (开仓价格 - 初始保证金 / 持仓量) / (1 - 维持保证金率) 
4. 因为 初始保证金 / 持仓量 = 开仓价格 / 杠杆
   清算价格 = 开仓价格 × (1 - 1/杠杆) / (1 - 维持保证金率)
```

#### 空头有保证金率清算
```
清算条件：初始保证金 + 持仓量 × (开仓价格 - 清算价格) = 持仓量 × 清算价格 × 维持保证金率

1. 初始保证金 = 持仓量 × 清算价格 × 维持保证金率 - 持仓量 × (开仓价格 - 清算价格)
2. 提取公因子 持仓量
   初始保证金 = 持仓量 × [清算价格 × 维持保证金率 - 开仓价格 + 清算价格]
3. 求解
   清算价格 × (维持保证金率 + 1) - 开仓价格 = 初始保证金 / 持仓量
   清算价格 = (开仓价格 + 初始保证金 / 持仓量) / (1 + 维持保证金率)
4. 因为 初始保证金 / 持仓量 = 开仓价格 / 杠杆
   清算价格 = 开仓价格 × (1 + 1/杠杆) / (1 + 维持保证金率)
```

### 总结
* `多头清算价格 = 开仓价格 - (保证金 / 持仓量)`
  * 表示价格下跌到何种程度会耗尽保证金。
* `空头清算价格 = 开仓价格 + (保证金 / 持仓量)`
  * 表示价格上涨到何种程度会耗尽保证金。
* 核心原理
  * 清算发生在未实现亏损等于初始保证金时。
  * 公式通过计算每单位持仓的保证金，确定价格波动的临界点。





 